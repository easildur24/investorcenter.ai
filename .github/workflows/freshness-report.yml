# =============================================================
# Data Freshness Report
# =============================================================
#
# NOTE: The production database is only reachable from within
# the Kubernetes cluster (ClusterIP).  This workflow is kept
# as a template for future use once a bastion / tunnel is
# available.  The primary deployment runs as a K8s CronJob
# (see ic-score-service/k8s/freshness-report-cronjob.yaml).
#
# To enable, add a publicly-reachable DB endpoint and set
# the PROD_DB_* GitHub secrets.
# =============================================================

name: Data Freshness Report

on:
  workflow_dispatch:  # Manual trigger only â€” disabled from schedule

jobs:
  freshness-report:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: pip install psycopg2-binary

    - name: Run freshness report
      id: report
      env:
        DB_HOST: ${{ secrets.PROD_DB_HOST }}
        DB_PORT: ${{ secrets.PROD_DB_PORT }}
        DB_USER: ${{ secrets.PROD_DB_USER }}
        DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
        DB_NAME: ${{ secrets.PROD_DB_NAME }}
        DB_SSLMODE: require
      run: |
        python scripts/freshness_report.py > report.md 2>&1; ec=$?
        cat report.md
        echo "exit_code=${ec}" >> "$GITHUB_OUTPUT"
      continue-on-error: true

    - name: Write report to job summary
      if: always()
      run: cat report.md >> "$GITHUB_STEP_SUMMARY"

    - name: Create or update GitHub issue on problems
      if: steps.report.outputs.exit_code != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('report.md', 'utf8');
          const exitCode = '${{ steps.report.outputs.exit_code }}';
          const severity = exitCode === '1' ? 'CRITICAL' : 'WARNING';
          const date = new Date().toISOString().split('T')[0];
          const title = `Data freshness ${severity} (${date})`;

          const body = [
            `## Data Freshness Report - ${severity}`,
            '',
            `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            `**Date:** ${new Date().toISOString()}`,
            `**Trigger:** ${context.eventName === 'schedule' ? 'Daily scheduled run' : 'Manual trigger'}`,
            '',
            '<details>',
            '<summary>Full Report</summary>',
            '',
            report,
            '',
            '</details>',
          ].join('\n');

          // Check for existing open issue
          const existing = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'data-freshness',
            state: 'open',
          });

          if (existing.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['data-freshness', severity === 'CRITICAL' ? 'critical' : 'warning'],
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existing.data[0].number,
              body: `Still ${severity.toLowerCase()} as of ${new Date().toISOString()}.\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n<details>\n<summary>Full Report</summary>\n\n${report}\n\n</details>`,
            });
          }

    - name: Auto-close issue when healthy
      if: steps.report.outputs.exit_code == '0'
      uses: actions/github-script@v7
      with:
        script: |
          const existing = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'data-freshness',
            state: 'open',
          });

          for (const issue of existing.data) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Resolved. All data is fresh and cronjobs are healthy as of ${new Date().toISOString()}.\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
            });
          }

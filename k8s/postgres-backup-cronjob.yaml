apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: investorcenter
spec:
  # Run daily at 3:00 AM UTC
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: postgres-backup
            image: postgres:15-alpine
            command:
            - /bin/sh
            - -c
            - |
              set -e

              # Install AWS CLI
              apk add --no-cache aws-cli gzip

              # Create timestamp for backup file
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="investorcenter_backup_${TIMESTAMP}.sql.gz"

              echo "Starting backup at $(date)"
              echo "Backup file: ${BACKUP_FILE}"

              # Run pg_dump and compress
              PGPASSWORD="${DB_PASSWORD}" pg_dump \
                -h "${DB_HOST}" \
                -U "${DB_USER}" \
                -d "${DB_NAME}" \
                --no-owner \
                --no-acl \
                -v | gzip > "/tmp/${BACKUP_FILE}"

              # Get file size
              FILESIZE=$(ls -lh "/tmp/${BACKUP_FILE}" | awk '{print $5}')
              echo "Backup complete. Size: ${FILESIZE}"

              # Upload to S3
              echo "Uploading to S3..."
              aws s3 cp "/tmp/${BACKUP_FILE}" "s3://investorcenter-db-backups/daily/${BACKUP_FILE}"

              echo "Backup uploaded successfully at $(date)"

              # Cleanup
              rm -f "/tmp/${BACKUP_FILE}"

              echo "Done!"
            env:
            - name: DB_HOST
              value: "postgres-simple-service"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            - name: DB_NAME
              value: "investorcenter_db"
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
            resources:
              requests:
                memory: "512Mi"
                cpu: "250m"
              limits:
                memory: "2Gi"
                cpu: "1000m"
